DELIMITER $$
CREATE PROCEDURE `sp_container_action`(
    IN p_action TINYINT, -- 1 = insert, 2 = mark as published
    IN p_container_number VARCHAR(25),
    IN p_container_type VARCHAR(15),
    IN p_container_status VARCHAR(30),
    IN p_status_date_time DATETIME,
    IN p_current_location_code VARCHAR(10),
    IN p_vessel_name VARCHAR(100),
    IN p_voyage_number VARCHAR(50),
    IN p_port_of_loading VARCHAR(10),
    IN p_port_of_discharge VARCHAR(10)
)
BEGIN
    DECLARE v_id INT;

    IF p_action = 1 THEN
        -- Action 1: Insert new container
        INSERT INTO Container_Info (
            container_number,
            container_type,
            container_status,
            status_date_time,
            current_location_code,
            vessel_name,
            voyage_number,
            port_of_loading,
            port_of_discharge,
            created_at,
            published_to_kafka,
            published_at
        ) VALUES (
            p_container_number,
            p_container_type,
            p_container_status,
            p_status_date_time,
            p_current_location_code,
            p_vessel_name,
            p_voyage_number,
            p_port_of_loading,
            p_port_of_discharge,
            NOW(),
            0,      -- Not published yet
            NULL
        );

    ELSEIF p_action = 2 THEN
        -- Action 2: Mark container as sent to Kafka
        SELECT container_id INTO v_id
        FROM Container_Info
        WHERE container_number = p_container_number
        LIMIT 1;

        IF v_id IS NOT NULL THEN
            UPDATE Container_Info
            SET published_to_kafka = 1,
                published_at = NOW()
            WHERE container_id = v_id;
        END IF;

    END IF;

END$$
DELIMITER ;
